{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>User Registration</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800;900&display=swap" rel="stylesheet" />
    <!--<link rel="shortcut icon" type="image/jpg" href="../static/images/favicon.ico"/>-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.3.1/css/all.min.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body, html {
            height: 100%;
            font-family: "Poppins", sans-serif;
        }
        a {
            font-size: 14px;
            line-height: 1.7;
            color: #fff;
            text-decoration: none;
            margin: 0;
            transition: all 0.4s;
        }
        a:focus {
            outline: none;
        }
        input {
            outline: none;
            border: none;
        }
        input::-webkit-input-placeholder {
            color: #8f8fa1;
        }
        .container-login100 {
            width: 100%;
            min-height: 100vh;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            padding: 10px;
            background-image: url("{% static 'images/sign_up.jpeg' %}");
            background-position: center;
            background-size: cover;
            background-repeat: no-repeat;
            position: relative;
            z-index: 1;
        }
        .container-login100::before {
            content: "";
            display: block;
            position: absolute;
            z-index: -1;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            background-color: rgba(0, 0, 0, 0.6);
        }
        .wrap-login100 {
            width: 450px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            position: relative;
            padding: 25px 30px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            max-height: none;
            overflow-y: visible;
        }
        .login100-form {
            width: 100%;
        }
        .login100-form-title {
            font-size: 22px;
            color: #403866;
            line-height: 1.2;
            text-transform: uppercase;
            text-align: center;
            width: 100%;
            display: block;
            margin-bottom: 20px;
        }
        .login100-form-title i {
            font-size: 45px;
            color: #00b665;
            margin-bottom: 15px;
            transition: 0.3s ease-in-out;
        }
        .logo-container {
            text-align: center;
            margin-bottom: 15px;
        }
        .logo-container img {
            max-width: 150px;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 182, 101, 0.5);
            transition: all 0.3s ease;
        }
        .logo-container img:hover {
            transform: scale(1.03);
            box-shadow: 0 6px 20px rgba(0, 182, 101, 0.7);
        }
        .input-label {
            display: block;
            color:rgb(181, 179, 195);
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 4px;
            text-align: left;
        }
        .wrap-input100 {
            width: 100%;
            position: relative;
            background-color: #e6e6e6;
            border: 1px solid transparent;
            border-radius: 3px;
            margin-bottom: 10px;
        }
        .input100 {
            color: #403866;
            line-height: 1.2;
            font-size: 14px;
            display: block;
            width: 100%;
            background-color: #f8f8f9;
            height: 42px;
            padding: 0px 20px;
            border-radius: 6px;
        }
        /* Form validation styling */
        .input100.valid {
            border: 1px solid #00b665;
            background-color: #f0fff8;
        }
        .input100.invalid {
            border: 1px solid #ff6b6b;
            background-color: #fff0f0;
        }
        .focus-input100 {
            position: absolute;
            display: block;
            width: calc(100% + 2px);
            height: calc(100% + 2px);
            top: -1px;
            left: -1px;
            pointer-events: none;
            border: 2px solid #00b665;
            border-radius: 3px;
            visibility: hidden;
            opacity: 0;
            transition: all 0.4s;
            transform: scaleX(1.1) scaleY(1.3);
        }
        .input100:focus + .focus-input100 {
            visibility: visible;
            opacity: 1;
            transform: scale(1);
        }
        .position-relative {
            position: relative;
        }
        /* Password strength indicator */
        .password-strength {
            margin-bottom: 15px;
            display: none;
        }
        .strength-bar {
            height: 6px;
            background-color: #e6e6e6;
            border-radius: 3px;
            margin-bottom: 5px;
            overflow: hidden;
        }
        .strength-indicator {
            height: 100%;
            width: 0;
            background-color: #ff6b6b;
            transition: width 0.3s, background-color 0.3s;
        }
        .strength-text {
            font-size: 12px;
            color: rgb(181, 179, 195);
            text-align: right;
        }
        .btn-primary {
            font-size: 14px;
            color: rgb(255, 255, 255);
            line-height: 1.2;
            text-transform: uppercase;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0 20px;
            width: 100%;
            height: 42px;
            background-color: #00b665;
            border-radius: 6px;
            transition: all 0.4s;
            border: none;
            cursor: pointer;
            font-weight: 600;
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(0, 182, 101, 0.3);
            margin-bottom: 12px;
        }
        .btn-primary:hover {
            background-color: #009954;
            box-shadow: 0 6px 20px rgba(0, 182, 101, 0.5);
            transform: translateY(-2px);
        }
        .refresh-captcha {
            color: #403866;
            font-size: 12px;
            margin-bottom: 12px;
            display: inline-block;
            transition: all 0.3s;
        }
        .refresh-captcha:hover {
            color: #00b665;
            text-decoration: underline;
        }
        .text-center {
            margin-top: 8px !important;
        }
        .text-center a {
            font-size: 13px;
            color: #403866;
            font-weight: 500;
            transition: all 0.3s;
        }
        .text-center a:hover {
            color: #00b665;
            text-decoration: underline;
        }
        .error-message {
            display: none;
            color: #ff6b6b;
            font-size: 12px;
            margin-bottom: 6px;
            text-align: left;
            font-weight: 500;
        }
        .input-group-text {
            background: transparent;
            border: none;
            color: #8f8fa1;
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 2;
            cursor: pointer;
        }
        .text-white {
            color: #fff !important;
        }
        .messages {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        #captchaBox {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 42px;
            font-family: monospace;
            font-size: 20px;
            letter-spacing: 3px;
            background-color: #f8f8f9;
            border: 1px solid #e6e6e6;
            border-radius: 6px;
            margin: 8px 0 10px;
            padding: 5px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }
        #captchaBox::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, transparent 49%, rgba(0,182,101,0.1) 50%, transparent 51%);
            background-size: 10px 10px;
            z-index: 0;
        }
        #captchaBox span {
            position: relative;
            z-index: 1;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.2);
            margin: 0 2px;
        }
        .pe-1 {
            padding-right: 0.25rem !important;
        }
        .mb-0 {
            margin-bottom: 0 !important;
        }
        .mb-2 {
            margin-bottom: 0.5rem !important;
        }
        .text-end {
            text-align: right !important;
        }
        .g-0 {
            --bs-gutter-x: 0;
            --bs-gutter-y: 0;
        }
        .row {
            display: flex;
            flex-wrap: wrap;
        }
        .col-12 {
            flex: 0 0 auto;
            width: 100%;
        }
        .col-7 {
            flex: 0 0 auto;
            width: 58.33333333%;
        }
        .col-5 {
            flex: 0 0 auto;
            width: 41.66666667%;
        }
    </style>
</head>
<body onload="generateCaptcha()">
    {% if messages %}
    <div class="messages">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="container-login100">
        <div class="wrap-login100">
            <form class="login100-form" method="post" id="registerForm" onsubmit="return validateForm(event)" autocomplete="off">
                {% csrf_token %}
                <!--<div class="logo-container">
                    <img src="{% static 'images/new_turf.jpeg' %}" alt="The SK Sports Park Logo">
                </div>-->
                <span class="login100-form-title">
                    Create Account
                </span>
                
                <label class="input-label" for="id_username">Username</label>
                <div class="wrap-input100">
                    <input class="input100" type="text" name="username" id="id_username" placeholder="Enter your username" required 
                           value="" 
                           onfocus="showUsernameInstructions()" onblur="hideUsernameInstructions()"
                           minlength="3" maxlength="30" pattern="^[a-zA-Z0-9_]+$"
                           oninput="validateUsername(); checkUsernameAvailability()" 
                           autocomplete="off" />
                    <span class="focus-input100"></span>
                </div>
                <div id="usernameFormatError" class="error-message">Username must be 3-30 characters, using only letters, numbers, and underscore.</div>
                <div id="usernameError" class="error-message">Username already taken. Please try a different one.</div>

                <label class="input-label" for="id_email">Email Address</label>
                <div class="wrap-input100">
                    <input class="input100" type="email" name="emailid" id="id_email" placeholder="Enter your email" required 
                           value="" 
                           onfocus="showEmailInstructions()" onblur="hideEmailInstructions()" 
                           oninput="validateEmail(); checkEmailAvailability()" 
                           autocomplete="off" />
                    <span class="focus-input100"></span>
                </div>
                <div id="emailError" class="error-message">Invalid email address!</div>
                <div id="emailExistsError" class="error-message">Email already registered. Please use a different email or log in.</div>

                <label class="input-label" for="id_password">Password</label>
                <div class="wrap-input100 position-relative">
                    <input class="input100" type="password" name="password" id="id_password" placeholder="Enter your password" required 
                           onfocus="showPasswordInstructions()" onblur="hidePasswordInstructions()"
                           oninput="validatePasswords()" 
                           autocomplete="new-password" />
                    <span class="focus-input100"></span>
                    <span class="input-group-text" onclick="togglePassword('id_password', 'pwdIcon')">
                        <i id="pwdIcon" class="fas fa-eye"></i>
                    </span>
                </div>
                <div id="passwordError" class="error-message">Password must be at least 8 characters long, contain uppercase, lowercase, number, and special character.</div>
                <div class="password-strength mb-2" id="passwordStrength">
                    <div class="strength-bar">
                        <div class="strength-indicator" id="strengthIndicator"></div>
                    </div>
                    <div class="strength-text" id="strengthText">Password Strength</div>
                </div>

                <label class="input-label" for="id_password_confirm">Confirm Password</label>
                <div class="wrap-input100 position-relative">
                    <input class="input100" type="password" name="password_confirm" id="id_password_confirm" placeholder="Confirm your password" required 
                           onfocus="showConfirmPasswordInstructions()" onblur="hideConfirmPasswordInstructions()"
                           oninput="validatePasswords()" 
                           autocomplete="new-password" />
                    <span class="focus-input100"></span>
                    <span class="input-group-text" onclick="togglePassword('id_password_confirm', 'confirmIcon')">
                        <i id="confirmIcon" class="fas fa-eye"></i>
                    </span>
                </div>
                <div id="passwordMatchError" class="error-message">Passwords do not match!</div>

                <div class="row g-0">
                    <div class="col-12">
                        <label class="input-label" for="id_captcha">Security Verification</label>
                    </div>
                    <div class="col-7 pe-1">
                        <div class="wrap-input100 mb-0">
                            <input class="input100" type="text" name="captcha" id="id_captcha" placeholder="Enter captcha" required 
                                   onfocus="showCaptchaInstructions()" onblur="hideCaptchaInstructions()"
                                   oninput="validateCaptcha()" />
                            <span class="focus-input100"></span>
                        </div>
                    </div>
                    <div class="col-5">
                        <div id="captchaBox" class="mb-0"></div>
                        <input type="hidden" id="hiddenCaptcha" name="hidden_captcha">
                    </div>
                </div>
                <div id="captchaError" class="error-message">Incorrect Captcha! Please try again.</div>
                <div class="text-end mb-2">
                    <a href="#" onclick="generateCaptcha()" class="refresh-captcha">Refresh Captcha</a>
                </div>

                <div class="container-login100-form-btn">
                    <button type="submit" class="btn-primary">CREATE MY ACCOUNT</button>
                </div>

                <div class="text-center mt-4">
                    <a href="{% url 'login' %}">Already have an account? Login here</a>
                </div>
            </form>
        </div>
    </div>

    <!-- Keep the existing JavaScript code unchanged -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.3.1/js/all.min.js"></script>
    <script>
        function generateCaptcha() {
            const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
            let captcha = "";
            let captchaHTML = "";

            for (let i = 0; i < 6; i++) {
                let char = chars.charAt(Math.floor(Math.random() * chars.length));
                let color = `rgb(${Math.floor(Math.random() * 120)}, ${Math.floor(Math.random() * 100 + 100)}, ${Math.floor(Math.random() * 120)})`;
                let rotation = Math.floor(Math.random() * 20 - 10);
                captcha += char;
                captchaHTML += `<span style="color:${color}; font-size:20px; font-weight:bold; margin: 0 2px; display: inline-block; transform: rotate(${rotation}deg);">${char}</span>`;
            }

            document.getElementById('captchaBox').innerHTML = captchaHTML;
            document.getElementById('hiddenCaptcha').value = captcha;
        }

        function validateUsername() {
            const username = document.getElementById("id_username").value;
            const usernameFormatError = document.getElementById("usernameFormatError");
            const usernameField = document.getElementById("id_username");
            
            // Check length and valid characters
            const isValidFormat = /^[a-zA-Z0-9_]{3,30}$/.test(username);
            
            if (!isValidFormat && username.length > 0) {
                usernameFormatError.style.display = "block";
                usernameField.classList.add("invalid");
                usernameField.classList.remove("valid");
                return false;
            } else {
                if (username.length === 0) {
                    usernameFormatError.style.display = "none";
                    usernameField.classList.remove("invalid");
                    usernameField.classList.remove("valid");
                } else {
                    usernameFormatError.style.display = "none";
                    usernameField.classList.remove("invalid");
                    usernameField.classList.add("valid");
                }
                return true;
            }
        }

        function validateEmail() {
            const email = document.getElementById("id_email").value;
            const emailError = document.getElementById("emailError");
            const emailField = document.getElementById("id_email");
            const emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;

            if (!emailPattern.test(email) && email.length > 0) {
                emailError.style.display = "block";
                emailField.classList.add("invalid");
                emailField.classList.remove("valid");
                return false;
            } else {
                if (email.length === 0) {
                    emailError.style.display = "none";
                    emailField.classList.remove("invalid");
                    emailField.classList.remove("valid");
                } else {
                    emailError.style.display = "none";
                    emailField.classList.remove("invalid");
                    emailField.classList.add("valid");
                }
                return true;
            }
        }

        function checkPasswordStrength(password) {
            // Show the password strength indicator
            document.getElementById("passwordStrength").style.display = "block";
            
            let strength = 0;
            const strengthBar = document.getElementById("strengthIndicator");
            const strengthText = document.getElementById("strengthText");
            
            // Calculate strength based on various criteria
            if (password.length >= 8) strength += 20;
            if (password.length >= 10) strength += 10;
            if (/[A-Z]/.test(password)) strength += 20;
            if (/[a-z]/.test(password)) strength += 20;
            if (/[0-9]/.test(password)) strength += 20;
            if (/[^A-Za-z0-9]/.test(password)) strength += 20;
            
            // Set width of strength bar and color based on strength
            strengthBar.style.width = `${Math.min(strength, 100)}%`;
            
            if (strength < 40) {
                strengthBar.style.backgroundColor = "#ff6b6b";
                strengthText.textContent = "Weak Password";
                strengthText.style.color = "#ff6b6b";
            } else if (strength < 70) {
                strengthBar.style.backgroundColor = "#ffa500";
                strengthText.textContent = "Moderate Password";
                strengthText.style.color = "#ffa500";
            } else {
                strengthBar.style.backgroundColor = "#00b665";
                strengthText.textContent = "Strong Password";
                strengthText.style.color = "#00b665";
            }
            
            return strength;
        }

        function validatePasswords() {
            const password = document.getElementById("id_password").value;
            const confirmPassword = document.getElementById("id_password_confirm").value;
            const passwordError = document.getElementById("passwordError");
            const matchError = document.getElementById("passwordMatchError");
            const passwordField = document.getElementById("id_password");
            const confirmField = document.getElementById("id_password_confirm");

            // Check password complexity
            const hasUpper = /[A-Z]/.test(password);
            const hasLower = /[a-z]/.test(password);
            const hasSpecial = /[^A-Za-z0-9]/.test(password);
            const hasNumber = /[0-9]/.test(password);
            const isLongEnough = password.length >= 8;
            
            // Check password strength
            if (password.length > 0) {
                const strength = checkPasswordStrength(password);
            } else {
                document.getElementById("passwordStrength").style.display = "none";
            }
            
            let isPasswordValid = true;
            let isConfirmValid = true;

            if ((!hasUpper || !hasLower || !hasSpecial || !hasNumber || !isLongEnough) && password.length > 0) {
                passwordError.style.display = "block";
                passwordField.classList.add("invalid");
                passwordField.classList.remove("valid");
                isPasswordValid = false;
            } else {
                if (password.length === 0) {
                    passwordError.style.display = "none";
                    passwordField.classList.remove("invalid");
                    passwordField.classList.remove("valid");
                } else {
                    passwordError.style.display = "none";
                    passwordField.classList.remove("invalid");
                    passwordField.classList.add("valid");
                }
            }
            
            // Check if passwords match (only if confirm field has a value)
            if (confirmPassword.length > 0) {
                if (password !== confirmPassword) {
                    matchError.style.display = "block";
                    confirmField.classList.add("invalid");
                    confirmField.classList.remove("valid");
                    isConfirmValid = false;
                } else {
                    matchError.style.display = "none";
                    confirmField.classList.remove("invalid");
                    confirmField.classList.add("valid");
                }
            } else {
                matchError.style.display = "none";
                confirmField.classList.remove("invalid");
                confirmField.classList.remove("valid");
            }
            
            return isPasswordValid && isConfirmValid;
        }

        function validateCaptcha() {
            const enteredCaptcha = document.getElementById("id_captcha").value;
            const actualCaptcha = document.getElementById("hiddenCaptcha").value;
            const captchaError = document.getElementById("captchaError");
            const captchaField = document.getElementById("id_captcha");
            
            if (enteredCaptcha.length > 0 && enteredCaptcha !== actualCaptcha) {
                captchaError.style.display = "block";
                captchaField.classList.add("invalid");
                captchaField.classList.remove("valid");
                return false;
            } else {
                if (enteredCaptcha.length === 0) {
                    captchaError.style.display = "none";
                    captchaField.classList.remove("invalid");
                    captchaField.classList.remove("valid");
                } else {
                    captchaError.style.display = "none";
                    captchaField.classList.remove("invalid");
                    captchaField.classList.add("valid");
                }
                return true;
            }
        }

        function togglePassword(inputId, eyeId) {
            let field = document.getElementById(inputId);
            let icon = document.getElementById(eyeId);

            if (field.type === "password") {
                field.type = "text";
                icon.classList.remove("fa-eye");
                icon.classList.add("fa-eye-slash");
            } else {
                field.type = "password";
                icon.classList.remove("fa-eye-slash");
                icon.classList.add("fa-eye");
            }
        }

        let usernameTimeout;
        function checkUsernameAvailability() {
            clearTimeout(usernameTimeout);
            const username = document.getElementById("id_username").value;
            const usernameError = document.getElementById("usernameError");
            const usernameField = document.getElementById("id_username");
            
            // Don't check if username is empty or too short
            if (!username || username.length < 3) {
                usernameError.style.display = "none";
                return;
            }

            // Set a timeout to avoid making too many requests as the user types
            usernameTimeout = setTimeout(() => {
                fetch(`/check_username/?username=${encodeURIComponent(username)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.exists) {
                            usernameError.style.display = "block";
                            usernameField.classList.add("invalid");
                            usernameField.classList.remove("valid");
                        } else {
                            usernameError.style.display = "none";
                            if (validateUsername()) {
                                usernameField.classList.remove("invalid");
                                usernameField.classList.add("valid");
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error checking username:', error);
                    });
            }, 500);
        }

        let emailTimeout;
        function checkEmailAvailability() {
            clearTimeout(emailTimeout);
            const email = document.getElementById("id_email").value;
            const emailExistsError = document.getElementById("emailExistsError");
            const emailField = document.getElementById("id_email");
            const emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
            
            // Don't check if email is empty or invalid
            if (!email || !emailPattern.test(email)) {
                emailExistsError.style.display = "none";
                return;
            }

            // Set a timeout to avoid making too many requests as the user types
            emailTimeout = setTimeout(() => {
                fetch(`/check_email/?email=${encodeURIComponent(email)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.exists) {
                            emailExistsError.style.display = "block";
                            emailField.classList.add("invalid");
                            emailField.classList.remove("valid");
                        } else {
                            emailExistsError.style.display = "none";
                            if (validateEmail()) {
                                emailField.classList.remove("invalid");
                                emailField.classList.add("valid");
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error checking email:', error);
                    });
            }, 500);
        }

        function validateForm(event) {
            event.preventDefault();
            
            // Check for empty fields first
            const username = document.getElementById("id_username").value.trim();
            const email = document.getElementById("id_email").value.trim();
            const password = document.getElementById("id_password").value;
            const confirmPassword = document.getElementById("id_password_confirm").value;
            const captcha = document.getElementById("id_captcha").value.trim();
            
            // Get all error message divs
            const usernameFormatError = document.getElementById("usernameFormatError");
            const emailError = document.getElementById("emailError");
            const passwordError = document.getElementById("passwordError");
            const matchError = document.getElementById("passwordMatchError");
            const captchaError = document.getElementById("captchaError");
            
            // Get all input fields
            const usernameField = document.getElementById("id_username");
            const emailField = document.getElementById("id_email");
            const passwordField = document.getElementById("id_password");
            const confirmField = document.getElementById("id_password_confirm");
            const captchaField = document.getElementById("id_captcha");
            
            let isValid = true;
            
            // Check for empty fields
            if (!username) {
                usernameFormatError.textContent = "Username is required";
                usernameFormatError.style.display = "block";
                usernameField.classList.add("invalid");
                usernameField.classList.remove("valid");
                isValid = false;
            }
            
            if (!email) {
                emailError.textContent = "Email address is required";
                emailError.style.display = "block";
                emailField.classList.add("invalid");
                emailField.classList.remove("valid");
                isValid = false;
            }
            
            if (!password) {
                passwordError.textContent = "Password is required";
                passwordError.style.display = "block";
                passwordField.classList.add("invalid");
                passwordField.classList.remove("valid");
                isValid = false;
            }
            
            if (!confirmPassword) {
                matchError.textContent = "Please confirm your password";
                matchError.style.display = "block";
                confirmField.classList.add("invalid");
                confirmField.classList.remove("valid");
                isValid = false;
            }
            
            if (!captcha) {
                captchaError.textContent = "Please enter the captcha";
                captchaError.style.display = "block";
                captchaField.classList.add("invalid");
                captchaField.classList.remove("valid");
                isValid = false;
            }
            
            // If any field is empty, focus on the first empty field and return
            if (!isValid) {
                if (!username) {
                    usernameField.focus();
                } else if (!email) {
                    emailField.focus();
                } else if (!password) {
                    passwordField.focus();
                } else if (!confirmPassword) {
                    confirmField.focus();
                } else if (!captcha) {
                    captchaField.focus();
                }
                return false;
            }
            
            // Reset error messages to their original content
            usernameFormatError.textContent = "Username must be 3-30 characters, using only letters, numbers, and underscore.";
            emailError.textContent = "Invalid email address!";
            passwordError.textContent = "Password must be at least 8 characters long, contain uppercase, lowercase, number, and special character.";
            matchError.textContent = "Passwords do not match!";
            captchaError.textContent = "Incorrect Captcha! Please try again.";
            
            // Now run the regular validation checks
            const isUsernameValid = validateUsername();
            const isEmailValid = validateEmail();
            const isPasswordValid = validatePasswords();
            const isCaptchaValid = validateCaptcha();
            
            // Check if username and email are available (not already in use)
            const usernameError = document.getElementById("usernameError");
            const emailExistsError = document.getElementById("emailExistsError");
            const isUsernameAvailable = usernameError.style.display !== "block";
            const isEmailAvailable = emailExistsError.style.display !== "block";

            // Submit the form if all validations pass
            if (isUsernameValid && isEmailValid && isPasswordValid && isCaptchaValid && 
                isUsernameAvailable && isEmailAvailable) {
                document.getElementById("registerForm").submit();
            } else {
                // Highlight the first field with an error
                if (!isUsernameValid || !isUsernameAvailable) {
                    document.getElementById("id_username").focus();
                } else if (!isEmailValid || !isEmailAvailable) {
                    document.getElementById("id_email").focus();
                } else if (!isPasswordValid) {
                    document.getElementById("id_password").focus();
                } else if (!isCaptchaValid) {
                    document.getElementById("id_captcha").focus();
                }
            }
        }
        
        // Add new functions to handle instructions show/hide
        function showUsernameInstructions() {
            if (document.getElementById("id_username").value.length === 0) {
                document.getElementById("usernameFormatError").style.display = "block";
            }
        }
        
        function hideUsernameInstructions() {
            if (document.getElementById("id_username").value.length === 0) {
                document.getElementById("usernameFormatError").style.display = "none";
            }
        }
        
        function showEmailInstructions() {
            if (document.getElementById("id_email").value.length === 0) {
                document.getElementById("emailError").style.display = "block";
            }
        }
        
        function hideEmailInstructions() {
            if (document.getElementById("id_email").value.length === 0) {
                document.getElementById("emailError").style.display = "none";
            }
        }
        
        function showPasswordInstructions() {
            if (document.getElementById("id_password").value.length === 0) {
                document.getElementById("passwordError").style.display = "block";
                document.getElementById("passwordStrength").style.display = "block";
            }
        }
        
        function hidePasswordInstructions() {
            if (document.getElementById("id_password").value.length === 0) {
                document.getElementById("passwordError").style.display = "none";
                document.getElementById("passwordStrength").style.display = "none";
            }
        }
        
        function showConfirmPasswordInstructions() {
            if (document.getElementById("id_password_confirm").value.length === 0) {
                document.getElementById("passwordMatchError").style.display = "block";
            }
        }
        
        function hideConfirmPasswordInstructions() {
            if (document.getElementById("id_password_confirm").value.length === 0) {
                document.getElementById("passwordMatchError").style.display = "none";
            }
        }
        
        function showCaptchaInstructions() {
            if (document.getElementById("id_captcha").value.length === 0) {
                document.getElementById("captchaError").style.display = "block";
            }
        }
        
        function hideCaptchaInstructions() {
            if (document.getElementById("id_captcha").value.length === 0) {
                document.getElementById("captchaError").style.display = "none";
            }
        }
        
        // Initialize captcha when page loads
        document.addEventListener('DOMContentLoaded', function() {
            generateCaptcha();
            
            // Hide all error messages by default
            document.getElementById("usernameFormatError").style.display = "none";
            document.getElementById("usernameError").style.display = "none";
            document.getElementById("emailError").style.display = "none";
            document.getElementById("emailExistsError").style.display = "none";
            document.getElementById("passwordError").style.display = "none";
            document.getElementById("passwordStrength").style.display = "none";
            document.getElementById("passwordMatchError").style.display = "none";
            document.getElementById("captchaError").style.display = "none";
            
            // Clear form fields on page load
            document.getElementById("id_username").value = "";
            document.getElementById("id_email").value = "";
            document.getElementById("id_password").value = "";
            document.getElementById("id_password_confirm").value = "";
            document.getElementById("id_captcha").value = "";
            
            // Add onfocus/onblur events for username
            document.getElementById("id_username").addEventListener('focus', showUsernameInstructions);
            document.getElementById("id_username").addEventListener('blur', hideUsernameInstructions);
            
            // Add input event listeners for real-time validation
            document.getElementById("id_captcha").addEventListener('input', validateCaptcha);
            
            // Add a listener to the submit button to validate fields when clicked
            document.querySelector('.btn-primary').addEventListener('click', function() {
                validateForm(event);
            });
        });
    </script>
</body>
</html>
